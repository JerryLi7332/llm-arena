# LLM Arena 后端源码目录

## 概述

`src` 目录是 LLM Arena 项目的核心后端代码，基于 FastAPI 框架构建，采用现代化的异步架构设计。该项目是一个支持多种游戏类型的 AI 代码竞技平台，允许用户上传、管理和使用 AI 代码进行游戏对战。

## 项目架构

```
src/
├── __init__.py          # 应用入口点和FastAPI应用创建
├── api/                 # API路由和端点定义
├── core/                # 核心功能和基础设施
├── games/               # 游戏逻辑实现
├── handlers/            # 请求处理器和数据处理器
├── log/                 # 日志系统
├── models/              # 数据模型和数据库模式
├── repositories/        # 数据访问层
├── schemas/             # Pydantic数据验证模式
├── services/            # 业务逻辑层
├── settings/            # 配置管理
└── utils/               # 工具函数和辅助模块
```

## 核心模块详解

### 1. 应用入口 (`__init__.py`)

- **FastAPI 应用创建**: 配置应用标题、版本、中间件等
- **生命周期管理**: 数据库连接初始化和清理
- **前端集成**: 支持 Vue.js 前端路由和静态资源服务
- **API 文档**: 自定义 Swagger UI 和 ReDoc 接口
- **CORS 支持**: 跨域资源共享配置

### 2. API 层 (`api/`)

- **RESTful API**: 提供标准的 HTTP 接口
- **版本控制**: 支持 API 版本管理 (`/api/v1/`)
- **认证授权**: JWT token 认证和权限控制
- **游戏接口**: 游戏相关的 API 端点
- **用户管理**: 用户注册、登录、权限管理等

### 3. 核心功能 (`core/`)

- **依赖注入**: 用户认证和权限验证
- **异常处理**: 统一的错误处理和响应格式
- **中间件**: CORS、认证、日志等中间件
- **应用初始化**: 数据库、路由、异常处理器注册
- **CRUD 操作**: 通用的数据库操作接口

### 4. 游戏系统 (`games/`)

- **游戏引擎**: 统一的游戏接口和自动发现机制
- **石头剪刀布**: 经典的石头剪刀布游戏实现
- **阿瓦隆**: 策略类社交推理游戏
- **扩展性**: 支持添加新的游戏类型
- **AI 对战**: AI 代码之间的自动对战系统

### 5. 数据模型 (`models/`)

- **AI 代码模型**: 存储用户上传的 AI 代码信息
- **游戏统计**: 记录用户的游戏表现和 ELO 评分
- **评论系统**: 用户对 AI 代码的评论和评分
- **标签管理**: 代码分类和标签系统
- **用户模型**: 用户账户和权限管理

### 6. 数据访问层 (`repositories/`)

- **抽象接口**: 定义数据访问的标准接口
- **实现类**: 具体的数据库操作实现
- **事务管理**: 数据库事务的协调和管理
- **缓存策略**: 数据缓存和性能优化

### 7. 业务逻辑层 (`services/`)

- **用户服务**: 用户注册、认证、权限管理
- **文件服务**: AI 代码文件的上传、存储、管理
- **游戏服务**: 游戏逻辑和 AI 对战协调
- **统计服务**: 游戏数据和排行榜计算

### 8. 配置管理 (`settings/`)

- **环境配置**: 支持 `.env` 文件和环境变量
- **数据库配置**: PostgreSQL 连接和连接池设置
- **安全配置**: JWT 密钥、过期时间等
- **CORS 配置**: 跨域请求的详细配置
- **日志配置**: 日志级别和输出格式

### 9. 工具模块 (`utils/`)

- **JWT 工具**: Token 生成和验证
- **密码工具**: 密码哈希和验证
- **缓存工具**: Redis 缓存操作
- **敏感词过滤**: 内容安全过滤

### 10. 日志系统 (`log/`)

- **结构化日志**: 支持 JSON 格式的日志输出
- **上下文管理**: 请求级别的日志上下文
- **性能监控**: 请求响应时间统计
- **错误追踪**: 异常和错误的详细记录

### 11. 请求处理 (`handlers/`)

- **数据处理器**: 请求数据的预处理和验证
- **敏感词过滤**: 用户输入内容的安全检查
- **请求验证**: 输入数据的格式和内容验证

## 技术特性

### 异步架构
- 基于 FastAPI 的异步 Web 框架
- 异步数据库操作 (Tortoise ORM)
- 高性能的并发处理能力

### 数据库设计
- 支持 PostgreSQL 数据库
- 连接池管理和性能优化
- 数据库迁移和版本控制

### 安全特性
- JWT 认证和授权
- 密码加密存储
- CORS 安全配置
- 敏感词过滤

### 前端集成
- 支持 Vue.js 单页应用
- 静态资源服务
- 前端路由支持

## 开发指南

### 环境要求
- Python 3.8+
- PostgreSQL 数据库
- Redis (可选，用于缓存)

### 安装依赖
```bash
pip install -r requirements.txt
```

### 运行应用
```bash
python start_server.py
```

### 数据库迁移
```bash
aerich upgrade
```

### API 文档
- Swagger UI: `/docs`
- ReDoc: `/redoc`
- OpenAPI JSON: `/openapi.json`

## 扩展开发

### 添加新游戏类型
1. 在 `games/` 目录下创建新的游戏模块
2. 实现标准的游戏接口
3. 在 `models/` 中添加相应的数据模型
4. 在 `api/` 中添加游戏相关的 API 端点

### 添加新的数据模型
1. 在 `models/` 目录下创建新的模型文件
2. 定义数据字段和关系
3. 创建相应的 Pydantic schema
4. 实现 CRUD 操作

### 自定义中间件
1. 在 `core/` 目录下创建中间件文件
2. 实现中间件逻辑
3. 在 `core/init_app.py` 中注册中间件

## 项目结构优势

- **模块化设计**: 清晰的职责分离和模块边界
- **可扩展性**: 支持新游戏类型和功能的轻松添加
- **可维护性**: 统一的代码风格和架构模式
- **性能优化**: 异步处理和数据库连接池
- **安全性**: 完善的认证授权和输入验证
- **开发体验**: 自动生成的 API 文档和类型提示

## 贡献指南

请参考项目根目录的 `CONTRIBUTING.md` 文件了解详细的贡献指南和代码规范。
